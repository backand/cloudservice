<div ng-if="rules.action">
  <div ng-cloak>
    <angled-window ng-show="rules.showJsCodeHelpDialog"
                   title="Help - JavaScript Code"
                   id="help"
                   grouping="w"
                   close-function="rules.showJsCodeHelpDialog = false"
                   rolled-up="false"
                   css-class="js-code-help">
      <div ng-include="'views/tables/rules/js_code_help.html'"></div>
    </angled-window>
  </div>
  <form name="rules.newRuleForm" insert-at-caret novalidate ng-submit="rules.saveAction()"
        ng-model-options="{updateOn: 'default blur', debounce: {'default': 300, blur: 0}}">
    <div class="header row">
      <div class="col-md-8">
        <div class="form-inline" name="rules.newRuleForm">
          <div class="form-group"
               ng-class="{'has-error': rules.newRuleForm.ruleName.$invalid}">

            <label for="ruleName"><h3 class="title">{{modal.title}} - </h3></label>

            <input type="text"
                   id="ruleName"
                   name="ruleName"
                   class="rule-name form-control"
                   ng-model="rules.action.name"
                   required
                   ng-pattern="rules.namePattern"
                   placeholder="Name your action"
                   ng-disabled="!rules.editMode || rules.isConstName(rules.action.name)">
            <ba-tooltip tooltip-text="Use the action name in the request URL query string of the REST API"
                        tooltip-placement="right" class=""></ba-tooltip>

            <span ng-show="rules.editMode && rules.isConstName(rules.action.name)">The action name cannot be modified.</span>

            <div ng-messages="rules.newRuleForm.ruleName.$error">
              <div ng-message="pattern" class="text-danger">Use only letters, numbers, space or underscore</div>
            </div>

          </div>
        </div>
      </div>
      <div class="col-md-4">

        <input type="button" ng-show="rules.allowEditAction()"
                ng-click="rules.editAction()"
                class="btn btn-primary pull-right with-margin"
          value="Edit Action">
        </input>

        <div ng-show="rules.editMode">
          <input type="button"
                 ng-click="rules.newRuleForm.$pristine ? rules.doneEdit() : rules.cancelEdit()"
                 class="btn btn-default pull-right with-margin"
                 value="{{ rules.newRuleForm.$pristine ? 'Done' : 'Cancel' }}">
          </input>

          <button ng-disabled="rules.newRuleForm.$invalid"
                  class="btn btn-primary pull-right with-margin"
                  ladda="rules.saving" data-style="expand-right">Save
          </button>
          <input type="button"
                 ng-click="rules.saveActionTemplate()"
                 ng-disabled="rules.newRuleForm.$invalid"
                 class="btn btn-primary pull-right with-margin"
                 data-style="expand-right"
                 value="Save Template">
          </input>
        </div>
      </div>
      <br/>

      <div class="col-xs-12">
        <input type="button" name="testCode"
               ng-show="!rules.isNewAction"
               class="pull-right btn btn-success btn-xs with-margin"
               ng-click="rules.toggleTestForm()"
               value="{{ rules.requestTestForm ? '<< Hide Test' : 'Test Action >>'}}">
        </input>
      </div>
    </div>

    <div class="clearfix">

      <fieldset ng-disabled="!rules.editMode">

        <div class="form-group col-lg-12 col-md-12 col-sm-12"
             ng-class="{'has-error': rules.newRuleForm.eventTrigger.$invalid}">
          <label>Event Trigger</label>
          <ba-tooltip
            tooltip-text="Select the event that will trigger the action: on-demand via REST API or by CRUD request"
            tooltip-placement="right" class=""></ba-tooltip>
          <select class="form-control"
                  ng-options="dataAction.value as dataAction.label for dataAction in modal.dataActions"
                  ng-model="rules.action.dataAction">
            <option value="">Select trigger...</option>
          </select>
        </div>

        <div class="form-group col-lg-12 col-md-12 col-sm-12" ng-show="rules.action.dataAction"
             ng-class="{'has-error': rules.newRuleForm.action.$invalid}">

          <label for="workflowAction">Type</label>
          <ba-tooltip
            tooltip-text="Select if you would like to run JavaScipt code, send email or execute database transaction script"
            tooltip-placement="right" class=""></ba-tooltip>
          <select class="form-control"
                  name="action"
                  id="workflowAction"
                  required
                  ng-options="workflowAction.value as workflowAction.label for workflowAction in modal.workflowActions"
                  ng-model="rules.action.workflowAction"
                  ng-model-options="{debounce: 0}"
                  ng-change="rules.onSelectWorkflowAction()">
            <option value="">Select what to do...</option>
          </select>

        </div>
        <div class="form-group col-lg-12 col-md-12 col-sm-12">
          <div ng-show="rules.useTemplate">
            <a href="" ng-repeat="template in rules.actionTemplates" ng-click="rules.templateToShow = template">
              <span ng-hide="template.json.imageUrl">{{template.name}}</span>
              <img class="action-template-icon" ng-show="template.json.imageUrl" ng-src="{{template.json.imageUrl}}">
            </a>

            <div ng-show="rules.templateToShow">
              <h3><a href="" ng-click="rules.selectTemplate(rules.templateToShow)" class="strong">{{rules.templateToShow.name}}</a></h3>
              <a href="" target="_blank">Documentation</a>
              <p>{{rules.templateToShow.shortDescription}}</p>
            </div>
          </div>

        </div>

        <div class="form-group col-lg-12 col-md-12 col-sm-12" ng-show="rules.action.workflowAction"
             ng-class="{'has-error': rules.newRuleForm.inputParameters.$invalid}">
          <label>Input Parameters</label>
          <ba-tooltip tooltip-text="Use this to send additional parameters to the action" tooltip-placement="right"
                      class=""></ba-tooltip>
          <input type="text"
                 ng-change="modal.buildParameters()"
                 name="inputParameters"
                 class="form-control"
                 ng-model="rules.action.inputParameters"
                 ng-pattern="rules.paramsPattern"
                 placeholder="input1,input2,....">
          <div ng-messages="rules.newRuleForm.inputParameters.$error">
            <div ng-message="pattern" class="text-danger">Use only letters, numbers and underscore for the parameters. Use commas as delimiters.</div>
          </div>
        </div>

        <div ng-switch="rules.action.workflowAction">

          <div class="form-group col-lg-12 col-md-12 col-sm-12" ng-if="rules.action.workflowAction">

            <!-- notify options -->
            <div ng-switch-when="Notify">


              <div class="form-group col-lg-6 col-md-6 col-sm-6"
                   ng-class="{'has-error': rules.newRuleForm.emailTo.$invalid}">

                <label for="emailTo">To:</label>
                <bknd-anchor anchor-params="rules.anchorParams"
                             window-title="Email Recipient"
                             input-id="emailTo"></bknd-anchor>
                <input type="text"
                       required
                       name="emailTo"
                       id="emailTo"
                       ng-model="rules.action.to"
                       class="form-control"/>

              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6"
                   ng-class="{'has-error': rules.newRuleForm.emailCc.$invalid}">
                <label for="emailCc">Cc:</label>

                <bknd-anchor anchor-params="rules.anchorParams"
                             window-title="Email - CC"
                             input-id="emailCc"></bknd-anchor>

                <input type="text"
                       name="emailCc"
                       id="emailCc"
                       ng-model="rules.action.cc"
                       class="form-control"/>
              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6"
                   ng-class="{'has-error': rules.newRuleForm.emailBcc.$invalid}">
                <label for="emailBcc">Bcc:</label>

                <bknd-anchor anchor-params="rules.anchorParams"
                             window-title="Email - BCC"
                             input-id="emailBcc"></bknd-anchor>

                <input type="text"
                       id="emailBcc"
                       name="emailBcc"
                       ng-model="rules.action.bcc"
                       class="form-control"/>
              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6"
                   ng-class="{'has-error': rules.newRuleForm.emailFrom.$invalid}">
                <label for="emailFrom">From:</label>

                <input type="text"
                       id="emailFrom"
                       name="emailFrom"
                       ng-model="rules.action.from"
                       placeholder="Leave empty for default"
                       class="form-control"/>
              </div>

              <div class="form-group col-lg-12 col-md-12 col-sm-12"
                   ng-class="{'has-error': rules.newRuleForm.emailSubject.$invalid}">

                <label for="emailSubject">Subject:</label>

                <bknd-anchor anchor-params="rules.anchorParams"
                             window-title="Email Subject"
                             input-id="emailSubject"></bknd-anchor>

                <input type="text"
                       required
                       name="emailSubject"
                       id="emailSubject"
                       ng-model="rules.action.subject"
                       ng-maxlength="200"
                       class="form-control"/>
              </div>

              <div class="form-group col-lg-12 col-md-12 col-sm-12"
                   ng-class="{'has-error': rules.newRuleForm.notifyMessage.$invalid}">

                <label for="emailMessage">Message:</label>

                <bknd-anchor anchor-params="rules.anchorParams"
                             window-title="Email Message"
                             input-id="emailMessage"></bknd-anchor>

          <textarea class="form-control"
                    name="emailMessage"
                    id="emailMessage"
                    ng-model="rules.action.notifyMessage"
                    style="resize: vertical" rows="10"
                    on-update="modal.digest()">
          </textarea>
              </div>

            </div>
            <!--./notify -->

            <div ng-switch-when="Validate">

              <div class="form-group col-lg-6 col-md-6 col-sm-6"
                   ng-class="{'has-error': rules.newRuleForm.validateExp1.$invalid}">
                <label for="validateExp1">Expression:</label>
          <textarea class="form-control"
                    required
                    name="validateExp1"
                    id="validateExp1"
                    ng-model="rules.action.validateCommand1"
                    style="resize: vertical"></textarea>
              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6">
                <label for="validateMessage1">Validation Failed Message:</label>
          <textarea class="form-control"
                    id="validateMessage1"
                    ng-model="rules.action.validateMessage1"
                    style="resize: vertical"></textarea>
              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6">
                <label for="validateCommand2">Expression:</label>
          <textarea class="form-control"
                    id="validateCommand2"
                    ng-model="rules.action.validateCommand2"
                    style="resize: vertical"></textarea>
              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6">
                <label for="validateMessage2">Validation Failed Message:</label>
          <textarea class="form-control"
                    id="validateMessage2"
                    ng-model="rules.action.validateMessage2"
                    style="resize: vertical"></textarea>
              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6">
                <label for="validateCommand3">Expression:</label>
          <textarea class="form-control"
                    id="validateCommand3"
                    ng-model="rules.action.validateCommand3"
                    style="resize: vertical"></textarea>
              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6">
                <label for="validateMessage3">Validation Failed Message:</label>
          <textarea class="form-control"
                    id="validateMessage3"
                    ng-model="rules.action.validateMessage3"
                    style="resize: vertical"></textarea>
              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6">
                <label for="validateCommand4">Expression:</label>
          <textarea class="form-control"
                    id="validateCommand4"
                    ng-model="rules.action.validateCommand4"
                    style="resize: vertical"></textarea>
              </div>

              <div class="form-group col-lg-6 col-md-6 col-sm-6">
                <label for="validateMessage4">Validation Failed Message:</label>
          <textarea class="form-control"
                    id="validateMessage4"
                    ng-model="rules.action.validateMessage4"
                    style="resize: vertical"></textarea>
              </div>

            </div>
            <!--./validate-->

            <div ng-switch-when="Execute">

              <div class="form-group col-lg-12 col-md-12 col-sm-12"
                   ng-class="{'has-error': rules.newRuleForm.sqlCommand.$invalid}">

                <label for="sqlCommand">Sql Script</label>
                <ba-tooltip tooltip-text="The script uses SQL syntax and allows you to update other tables"
                            tooltip-placement="right" class=""></ba-tooltip>

                <bknd-anchor anchor-params="rules.anchorParams"
                             window-title="SQL Command"
                             input-id="sqlCommand"></bknd-anchor>

                <div
                  ui-ace="{onLoad : ace.onLoad, theme:'dawn', mode: ace.dbType, rendererOptions: { fontSize: 15 }}"
                  class="form-control"
                  name="sqlCommand"
                  id="sqlCommand"
                  ng-model="rules.action.command"
                  required
                  style="resize: vertical">
                </div>
              </div>

              <div class="form-group col-lg-12 col-md-12 col-sm-12"
                   ng-class="{'has-error': rules.newRuleForm.sqlMessage.$invalid}">
                <label for="sqlMessage">Message:</label>
                <ba-tooltip tooltip-text="Returned message in case the sql script failed" tooltip-placement="right"
                            class=""></ba-tooltip>

          <textarea class="form-control"
                    ng-model="rules.action.executeMessage"
                    name="sqlMessage"
                    id="sqlMessage"
                    style="resize: vertical"></textarea>
              </div>
            </div>

            <div ng-switch-when="WebService">

              <div class="form-group col-lg-12 col-md-12 col-sm-12"
                   ng-class="{'has-error': rules.newRuleForm.webService.$invalid}">

                <label for="webService">Web Service URL:</label>

                <bknd-anchor anchor-params="rules.anchorParams"
                             window-title="Web Service URL"
                             input-id="webService"></bknd-anchor>

          <textarea class="form-control"
                    name="webService"
                    id="webService"
                    ng-model="rules.action.webServiceUrl"
                    required
                    style="resize: vertical"></textarea>
              </div>


            </div>
            <!--code-->
            <div ng-switch-when="JavaScript">

              <div ng-class="{'has-error': rules.newRuleForm.code.$invalid}">

                <div class="form-group" ng-class="{'ace-full-screen': aceFullScreen, 'ace-show-test': rules.requestTestForm}">
                  <label for="code">JavaScript Code</label> <a href="" ng-click="rules.showJsCodeHelpDialog = true">Need help?</a>

                  <div
                    ui-ace="{onLoad : ace.onLoad, theme:'monokai', mode: 'javascript', rendererOptions: { fontSize: 15 }}"
                    class="form-control ace-rule"
                    name="code"
                    id="code"
                    ng-model="rules.action.code"
                    required
                    ng-pattern="rules.codePattern"
                    ng-keydown="modal.handleTabKey($event)"
                    style="resize: vertical; ">
                  </div>
                  <input type="button" ng-show="rules.editMode"
                         class="btn btn-sm btn-primary full-screen-button"
                         ng-click="aceFullScreen = !aceFullScreen"
                         value="{{ aceFullScreen ? 'Minimize' : 'Maximize' }}">

                  <!-- workaround: ui-ace doesn't work well in input, ng-pattern doesn't work on div-->
                  <input ng-hide="true" name="codeHidden" ng-model="rules.action.code" ng-pattern="rules.codePattern">
                  <div ng-messages="rules.newRuleForm.codeHidden.$error">
                    <div ng-message="pattern" class="text-danger">Please use the original function signature.</div>
                  </div>
                </div>
              </div>
            </div>
            <!-- end switch -->
          </div>
          <div class="form-group col-lg-12 col-md-12 col-sm-12" ng-show="rules.action.workflowAction"
               ng-class="{'has-error': rules.newRuleForm.whereCondition.$invalid && rules.newRuleForm.whereCondition.$dirty}">
            <label for="whereCondition">Where Condition</label>
            <ba-tooltip tooltip-text="SQL where clause that determines if the action will be performed"
                        tooltip-placement="right" class=""></ba-tooltip>

            <bknd-anchor anchor-params="rules.anchorParams"
                         window-title="Where Condition"
                         input-id="whereCondition"
                         prev-needed="true"></bknd-anchor>

            <div ui-ace="{onLoad : ace.onLoad, theme:'dawn', mode: ace.dbType, rendererOptions: { fontSize: 15 }}"
                 id="whereCondition"
                 required
                 name="whereCondition"
                 class="form-control ace-action-where"
                 placeholder=""
                 ng-model="rules.action.whereCondition"
                 style="resize: vertical">
            </div>
            <span ng-show="rules.editMode">** Enter 'true' to ensure the action always executes, or use the anchor icon to build a condition governing the execution</span>
          </div>

          <div class="modal-footer" ng-show="rules.action && rules.editMode">
            <button class="btn btn-primary" ng-disabled="rules.newRuleForm.$invalid"
                    ladda="rules.saving" data-style="expand-right">Save
            </button>
            <input type="button"
                   class="btn btn-danger pull-left"
                   ng-click="rules.deleteAction()"
                   ng-if="rules.action.__metadata"
                   value="Delete">
            </input>
            <input type="button"
                   class="btn btn-default"
                   ng-click="rules.newRuleForm.$pristine ? rules.doneEdit() : rules.cancelEdit()"
                   value="{{ rules.newRuleForm.$pristine ? 'Done' : 'Cancel'}}">
            </input>
          </div>
        </div>
      </fieldset>

    </div>
  </form>
</div>
